<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFB627">
<title>SunFusion Â· Fleet Manager</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=DM+Mono:wght@400;500&family=Exo+2:wght@300;400;500;600&display=swap');

:root {
  --bg:#050910; --bg-card:#0b1422; --bg-panel:#0d1a2a;
  --border:rgba(255,255,255,0.10); --border-hi:rgba(255,255,255,0.20);
  --txt:#f0f4f8; --txt-2:#8aacc8; --txt-3:#4a7090;
  --sol:#FFB627; --sol-d:#E09800; --sol-g:rgba(255,182,39,0.15);
  --bat:#00E5A0; --bat-g:rgba(0,229,160,0.12);
  --grd:#38B6FF; --grd-g:rgba(56,182,255,0.12);
  --danger:#ff4444; --warn:#ffaa00;
  --r:12px;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; background:var(--bg); color:var(--txt); font-family:'Exo 2',sans-serif; overflow:hidden; }

/* â”€â”€ ADMIN LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.login-screen { position:fixed; inset:0; z-index:9000; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }
.login-screen.hidden { display:none; }
.login-logo { font-size:64px; filter:drop-shadow(0 0 20px var(--sol-g)); }
.login-title { font-family:'Orbitron',sans-serif; font-size:36px; font-weight:900; letter-spacing:12px; background:linear-gradient(135deg,var(--sol),#fff8e0); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.login-sub { font-size:12px; letter-spacing:4px; color:var(--txt-2); text-transform:uppercase; font-family:'DM Mono',monospace; }
.login-form { display:flex; flex-direction:column; gap:12px; width:100%; max-width:360px; padding:0 20px; margin-top:10px; }
.login-inp { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:14px 18px; color:var(--txt); font-family:'DM Mono',monospace; font-size:16px; outline:none; text-align:center; letter-spacing:4px; transition:border-color 0.2s; }
.login-inp:focus { border-color:var(--sol); }
.login-inp.err { border-color:var(--danger); animation:shake 0.3s ease; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
.login-btn { padding:14px; background:linear-gradient(135deg,var(--sol),var(--sol-d)); border:none; border-radius:12px; color:#0a0800; font-family:'Orbitron',sans-serif; font-size:14px; letter-spacing:4px; cursor:pointer; font-weight:700; box-shadow:0 4px 30px var(--sol-g); transition:all 0.2s; }
.login-btn:hover { transform:translateY(-2px); box-shadow:0 8px 40px var(--sol-g); }
.login-note { font-size:11px; color:var(--txt-3); text-align:center; font-family:'DM Mono',monospace; letter-spacing:1px; }
.login-customer-link { color:var(--grd); text-decoration:none; font-family:'DM Mono',monospace; font-size:12px; letter-spacing:1px; margin-top:8px; }
.login-customer-link:hover { color:var(--sol); }
.login-lock-btn { display:flex; align-items:center; gap:6px; padding:6px 14px; border:1px solid var(--border); border-radius:8px; background:none; color:var(--txt-3); font-family:'DM Mono',monospace; font-size:10px; letter-spacing:1px; cursor:pointer; transition:all 0.2s; }
.login-lock-btn:hover { border-color:var(--danger); color:var(--danger); }

/* â”€â”€ ACCESS CODE DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.access-code { font-family:'Orbitron',sans-serif; font-size:13px; font-weight:700; letter-spacing:3px; color:var(--bat); background:rgba(0,229,160,0.08); padding:3px 10px; border-radius:6px; border:1px solid rgba(0,229,160,0.15); display:inline-block; cursor:pointer; user-select:all; }
.access-code:hover { background:rgba(0,229,160,0.15); }

/* â”€â”€ SETUP GUIDE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.guide-modal { max-width:640px; max-height:92vh; }
.guide-step { margin-bottom:18px; padding:14px; background:var(--bg); border:1px solid var(--border); border-radius:10px; }
.guide-step-num { display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius:50%; background:var(--sol); color:#0a0800; font-family:'Orbitron',sans-serif; font-size:11px; font-weight:700; margin-right:8px; flex-shrink:0; }
.guide-step-title { font-family:'Orbitron',sans-serif; font-size:12px; font-weight:700; letter-spacing:2px; color:var(--txt); display:flex; align-items:center; margin-bottom:10px; }
.guide-text { font-size:12px; color:var(--txt-2); line-height:1.6; font-family:'Exo 2',sans-serif; }
.guide-text b { color:var(--txt); }
.guide-text .hl { color:var(--sol); font-weight:600; }
.guide-text .hl-blue { color:var(--grd); font-weight:600; }
.guide-text .hl-green { color:var(--bat); font-weight:600; }
.guide-code-block { background:var(--bg-card); border:1px solid var(--border-hi); border-radius:8px; padding:10px 14px; margin:8px 0; font-family:'DM Mono',monospace; font-size:11px; color:var(--grd); position:relative; overflow-x:auto; line-height:1.7; word-break:break-all; }
.guide-code-block .lbl { display:block; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--txt-3); margin-bottom:4px; font-weight:500; }
.guide-code-block .val { color:var(--sol); font-size:12px; letter-spacing:1px; user-select:all; }
.guide-code-block .val-green { color:var(--bat); font-size:12px; letter-spacing:1px; user-select:all; font-weight:600; }
.guide-code-block .val-blue { color:var(--grd); font-size:12px; letter-spacing:0.5px; user-select:all; }
.guide-copy-btn { position:absolute; top:6px; right:6px; background:rgba(255,182,39,0.1); border:1px solid rgba(255,182,39,0.2); border-radius:6px; padding:4px 10px; color:var(--sol); font-family:'DM Mono',monospace; font-size:10px; cursor:pointer; letter-spacing:1px; transition:all 0.2s; }
.guide-copy-btn:hover { background:rgba(255,182,39,0.2); }
.guide-arrow { text-align:center; font-size:18px; color:var(--txt-3); margin:4px 0; }
.guide-divider { border:none; border-top:1px solid var(--border); margin:14px 0; }
.guide-img-ref { background:rgba(56,182,255,0.06); border:1px dashed rgba(56,182,255,0.2); border-radius:8px; padding:10px 14px; margin:8px 0; }

.root { display:flex; flex-direction:column; height:100%; }

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hdr { display:flex; align-items:center; justify-content:space-between; padding:10px 20px; border-bottom:1px solid var(--border); flex-shrink:0; background:var(--bg-card); }
.hdr-left { display:flex; align-items:center; gap:12px; }
.hdr-logo { width:36px; height:36px; border-radius:8px; background:linear-gradient(135deg,var(--sol),var(--sol-d)); display:flex; align-items:center; justify-content:center; font-size:18px; }
.hdr-title { font-family:'Orbitron',sans-serif; font-size:16px; font-weight:700; letter-spacing:4px; }
.hdr-sub { font-size:11px; color:var(--txt-2); font-family:'DM Mono',monospace; letter-spacing:2px; }
.hdr-stats { display:flex; gap:16px; align-items:center; }
.hdr-stat { text-align:center; }
.hdr-stat-val { font-family:'Orbitron',sans-serif; font-size:18px; font-weight:700; color:var(--sol); }
.hdr-stat-lbl { font-size:9px; color:var(--txt-2); font-family:'DM Mono',monospace; letter-spacing:2px; text-transform:uppercase; }
.hdr-actions { display:flex; gap:8px; }
.btn { padding:8px 16px; border-radius:8px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:1px; cursor:pointer; transition:all 0.2s; border:1px solid var(--border); background:none; color:var(--txt-2); }
.btn:hover { border-color:var(--sol); color:var(--sol); }
.btn-gold { background:linear-gradient(135deg,var(--sol),var(--sol-d)); color:#0a0800; border:none; font-weight:600; }
.btn-gold:hover { box-shadow:0 4px 20px var(--sol-g); transform:translateY(-1px); }
.btn-danger { border-color:rgba(255,68,68,0.3); color:var(--danger); }
.btn-danger:hover { background:rgba(255,68,68,0.1); }

/* â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar { display:flex; align-items:center; gap:10px; padding:10px 20px; border-bottom:1px solid var(--border); flex-shrink:0; flex-wrap:wrap; }
.search-box { flex:1; min-width:200px; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:8px 14px 8px 34px; color:var(--txt); font-family:'DM Mono',monospace; font-size:12px; outline:none; transition:border-color 0.2s; }
.search-box:focus { border-color:var(--sol); }
.search-wrap { position:relative; flex:1; min-width:200px; }
.search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:14px; opacity:0.4; pointer-events:none; }
.view-toggle { display:flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
.view-btn { padding:7px 14px; background:none; border:none; color:var(--txt-2); font-family:'DM Mono',monospace; font-size:11px; cursor:pointer; transition:all 0.2s; letter-spacing:1px; }
.view-btn.active { background:var(--sol-g); color:var(--sol); }
.filter-select { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:7px 12px; color:var(--txt-2); font-family:'DM Mono',monospace; font-size:11px; outline:none; cursor:pointer; }
.filter-select option { background:var(--bg-card); color:var(--txt); }

/* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex:1; display:flex; min-height:0; position:relative; }
.map-view { flex:1; position:relative; }
#map { width:100%; height:100%; background:var(--bg); }
.list-view { flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; display:none; }
.list-view.active { display:block; }
.map-view.hidden { display:none; }

/* Leaflet dark theme overrides */
.leaflet-container { background:var(--bg)!important; }
.leaflet-tile-pane { filter:brightness(0.7) saturate(0.8) hue-rotate(180deg) invert(1); }
.leaflet-control-zoom a { background:var(--bg-card)!important; color:var(--txt)!important; border-color:var(--border)!important; }
.leaflet-control-attribution { background:rgba(5,9,15,0.8)!important; color:var(--txt-3)!important; font-size:9px!important; }
.leaflet-control-attribution a { color:var(--txt-2)!important; }

/* Custom cluster icons */
.cluster-icon { border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:'Orbitron',sans-serif; font-weight:700; font-size:12px; color:#0a0800; border:2px solid rgba(255,255,255,0.2); box-shadow:0 2px 12px rgba(0,0,0,0.5); }
.cluster-sm { background:var(--bat); width:36px; height:36px; }
.cluster-md { background:var(--sol); width:44px; height:44px; font-size:13px; }
.cluster-lg { background:var(--danger); width:52px; height:52px; font-size:14px; }

/* Map popup */
.sys-popup { font-family:'Exo 2',sans-serif; min-width:220px; }
.sys-popup-name { font-family:'Orbitron',sans-serif; font-size:13px; font-weight:700; color:var(--sol); letter-spacing:1px; margin-bottom:4px; }
.sys-popup-ip { font-family:'DM Mono',monospace; font-size:11px; color:var(--txt-2); margin-bottom:6px; }
.sys-popup-row { display:flex; justify-content:space-between; font-size:11px; padding:2px 0; color:var(--txt); }
.sys-popup-btn { display:block; width:100%; margin-top:8px; padding:8px; background:var(--sol); border:none; border-radius:6px; color:#0a0800; font-family:'Orbitron',sans-serif; font-size:10px; font-weight:700; letter-spacing:2px; cursor:pointer; text-align:center; text-decoration:none; }
.leaflet-popup-content-wrapper { background:var(--bg-card)!important; color:var(--txt)!important; border:1px solid var(--border)!important; border-radius:12px!important; box-shadow:0 8px 32px rgba(0,0,0,0.5)!important; }
.leaflet-popup-tip { background:var(--bg-card)!important; border:1px solid var(--border)!important; }
.leaflet-popup-close-button { color:var(--txt-2)!important; font-size:18px!important; }

/* â”€â”€ LIST VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sys-table { width:100%; border-collapse:collapse; }
.sys-table th { position:sticky; top:0; background:var(--bg-card); padding:10px 14px; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--txt-2); text-align:left; border-bottom:1px solid var(--border); z-index:2; cursor:pointer; user-select:none; white-space:nowrap; }
.sys-table th:hover { color:var(--sol); }
.sys-table th .sort-arrow { opacity:0.3; margin-left:4px; }
.sys-table th.sorted .sort-arrow { opacity:1; color:var(--sol); }
.sys-table td { padding:8px 14px; font-size:12px; border-bottom:1px solid var(--border); white-space:nowrap; }
.sys-table tr { cursor:pointer; transition:background 0.15s; }
.sys-table tbody tr:hover { background:rgba(255,182,39,0.04); }
.sys-name { font-family:'Orbitron',sans-serif; font-size:11px; font-weight:600; color:var(--txt); letter-spacing:1px; }
.sys-ip { font-family:'DM Mono',monospace; font-size:11px; color:var(--grd); }
.sys-group-tag { display:inline-block; padding:2px 8px; border-radius:100px; font-size:9px; font-family:'DM Mono',monospace; letter-spacing:1px; background:rgba(255,182,39,0.08); color:var(--sol); border:1px solid rgba(255,182,39,0.15); }
.status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; }
.status-dot.online { background:var(--bat); box-shadow:0 0 6px var(--bat-g); }
.status-dot.offline { background:var(--danger); }
.status-dot.unknown { background:var(--txt-3); }

/* â”€â”€ ADD/EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-bg { position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.modal-bg.open { opacity:1; pointer-events:all; }
.modal { background:var(--bg-card); border:1px solid var(--border-hi); border-radius:16px; padding:24px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:0 0 60px rgba(0,0,0,0.6); }
.modal-title { font-family:'Orbitron',sans-serif; font-size:14px; letter-spacing:3px; color:var(--sol); margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; }
.m-group { margin-bottom:12px; }
.m-lbl { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--txt-2); margin-bottom:4px; display:block; font-family:'DM Mono',monospace; }
.m-inp { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:10px 14px; color:var(--txt); font-family:'DM Mono',monospace; font-size:12px; outline:none; }
.m-inp:focus { border-color:var(--sol); }
.m-hint { font-size:10px; color:var(--txt-3); margin-top:3px; font-family:'DM Mono',monospace; }
.m-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.m-btns { display:flex; gap:10px; margin-top:16px; }
.m-btns .btn { flex:1; padding:12px; text-align:center; }

/* â”€â”€ CSV IMPORT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.csv-drop { border:2px dashed var(--border); border-radius:12px; padding:40px 20px; text-align:center; cursor:pointer; transition:all 0.3s; }
.csv-drop:hover, .csv-drop.drag { border-color:var(--sol); background:var(--sol-g); }
.csv-drop-text { font-family:'DM Mono',monospace; font-size:12px; color:var(--txt-2); letter-spacing:1px; }
.csv-preview { margin-top:12px; max-height:200px; overflow-y:auto; font-family:'DM Mono',monospace; font-size:10px; color:var(--txt-2); background:var(--bg); border-radius:8px; padding:10px; }

/* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:16px; padding:40px; }
.empty-icon { font-size:64px; opacity:0.5; }
.empty-title { font-family:'Orbitron',sans-serif; font-size:16px; letter-spacing:4px; color:var(--txt-2); }
.empty-sub { font-size:12px; color:var(--txt-3); text-align:center; max-width:400px; line-height:1.8; font-family:'DM Mono',monospace; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:768px) {
  .hdr { flex-wrap:wrap; gap:8px; padding:8px 12px; }
  .hdr-stats { gap:10px; }
  .hdr-stat-val { font-size:14px; }
  .toolbar { padding:8px 12px; }
  .sys-table td, .sys-table th { padding:6px 8px; font-size:10px; }
  .modal { width:95%; padding:16px; }
}
</style>
</head>
<body>

<!-- ADMIN LOGIN SCREEN -->
<div class="login-screen" id="login-screen">
  <div class="login-logo">â˜€ï¸</div>
  <div class="login-title">SUNFUSION</div>
  <div class="login-sub">Fleet Management</div>
  <div class="login-form">
    <input class="login-inp" id="login-pass" type="password" placeholder="Admin Password" maxlength="30" onkeydown="if(event.key==='Enter')adminLogin()">
    <button class="login-btn" onclick="adminLogin()">LOGIN</button>
    <div class="login-note" id="login-msg"></div>
    <a class="login-customer-link" href="customer.html">ğŸ  Customer? Look up your system here â†’</a>
  </div>
</div>

<div class="root" id="fleet-root" style="display:none">
  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-left">
      <div class="hdr-logo">â˜€</div>
      <div>
        <div class="hdr-title">SUNFUSION FLEET</div>
        <div class="hdr-sub">System Management</div>
      </div>
    </div>
    <div class="hdr-stats">
      <div class="hdr-stat"><div class="hdr-stat-val" id="stat-total">0</div><div class="hdr-stat-lbl">Systems</div></div>
      <div class="hdr-stat"><div class="hdr-stat-val" id="stat-online" style="color:var(--bat)">0</div><div class="hdr-stat-lbl">Online</div></div>
      <div class="hdr-stat"><div class="hdr-stat-val" id="stat-offline" style="color:var(--danger)">0</div><div class="hdr-stat-lbl">Offline</div></div>
    </div>
    <div class="hdr-actions">
      <button class="btn btn-gold" onclick="openAddModal()">+ ADD SYSTEM</button>
      <button class="btn" onclick="openModal('modal-setup')" title="New System Setup Guide" style="border-color:rgba(56,182,255,0.3);color:var(--grd)">ğŸ“– SETUP GUIDE</button>
      <button class="btn" onclick="openImportModal()">ğŸ“¥ IMPORT CSV</button>
      <button class="btn" onclick="exportCSV()">ğŸ“¤ EXPORT</button>
      <button class="login-lock-btn" onclick="lockFleet()" title="Lock & Logout">ğŸ”’ LOCK</button>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <div class="search-wrap">
      <div class="search-icon">ğŸ”</div>
      <input class="search-box" id="search" placeholder="Search by name, IP, group, zip code..." oninput="renderView()">
    </div>
    <select class="filter-select" id="filter-group" onchange="renderView()">
      <option value="">All Groups</option>
    </select>
    <select class="filter-select" id="filter-status" onchange="renderView()">
      <option value="">All Status</option>
      <option value="online">Online</option>
      <option value="offline">Offline</option>
      <option value="unknown">Unknown</option>
    </select>
    <div class="view-toggle">
      <button class="view-btn active" id="vbtn-map" onclick="setView('map')">ğŸ—º MAP</button>
      <button class="view-btn" id="vbtn-list" onclick="setView('list')">ğŸ“‹ LIST</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="map-view" id="map-container">
      <div id="map"></div>
    </div>
    <div class="list-view" id="list-container">
      <table class="sys-table">
        <thead>
          <tr>
            <th onclick="sortBy('status')">Status <span class="sort-arrow">â–¼</span></th>
            <th onclick="sortBy('name')" class="sorted">Name <span class="sort-arrow">â–¼</span></th>
            <th onclick="sortBy('ip')">IP Address <span class="sort-arrow">â–¼</span></th>
            <th onclick="sortBy('code')">Access Code <span class="sort-arrow">â–¼</span></th>
            <th onclick="sortBy('group')">Group <span class="sort-arrow">â–¼</span></th>
            <th onclick="sortBy('zip')">Zip <span class="sort-arrow">â–¼</span></th>
            <th onclick="sortBy('lastSeen')">Last Seen <span class="sort-arrow">â–¼</span></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="sys-tbody"></tbody>
      </table>
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">â˜€ï¸</div>
        <div class="empty-title">NO SYSTEMS YET</div>
        <div class="empty-sub">Add systems one at a time or import thousands from a CSV file.<br>Each system just needs a <b style="color:var(--sol)">name</b> and <b style="color:var(--sol)">IP address</b>.</div>
        <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;justify-content:center">
          <button class="btn btn-gold" onclick="openAddModal()">+ ADD SYSTEM</button>
          <button class="btn" onclick="openImportModal()">ğŸ“¥ IMPORT CSV</button>
          <button class="btn" onclick="downloadSampleCSV()">ğŸ“‹ DOWNLOAD TEMPLATE</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modal-bg" id="modal-add">
  <div class="modal">
    <div class="modal-title"><span id="modal-add-title">ADD SYSTEM</span> <button class="btn" onclick="closeModal('modal-add')">âœ•</button></div>
    <div class="m-group">
      <label class="m-lbl">System Name</label>
      <input class="m-inp" id="m-name" placeholder="e.g. Smith Residence, Warehouse #12">
      <div class="m-hint">A friendly name to identify this installation</div>
    </div>
    <div class="m-row">
      <div class="m-group">
        <label class="m-lbl">IP Address</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="m-inp" id="m-ip" placeholder="192.168.0.165" inputmode="url" style="flex:1">
          <button class="btn" onclick="copyField('m-ip')" style="white-space:nowrap;padding:10px 14px">ğŸ“‹</button>
        </div>
        <div class="m-hint">SA â†’ Local network â€” paste only the numbers</div>
      </div>
      <div class="m-group">
        <label class="m-lbl">Port</label>
        <input class="m-inp" id="m-port" value="9001" inputmode="numeric">
      </div>
    </div>
    <div class="m-group">
      <label class="m-lbl">Cloud Proxy (Site ID)</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="m-inp" id="m-siteid" placeholder="e.g. sunfusionenergysystems.us.solar-assistant.io" style="flex:1">
        <button class="btn" onclick="copySiteURL()" id="btn-copy-site" style="white-space:nowrap;padding:10px 14px">ğŸ“‹ COPY URL</button>
      </div>
      <div class="m-hint">From SA â†’ Settings â†’ Remote Access â†’ Cloud proxy. Paste the full URL â€” https:// is stripped automatically.</div>
    </div>
    <div class="m-row">
      <div class="m-group">
        <label class="m-lbl">Zip Code</label>
        <input class="m-inp" id="m-zip" placeholder="92081" inputmode="numeric" maxlength="5">
        <div class="m-hint">For weather & map location</div>
      </div>
      <div class="m-group">
        <label class="m-lbl">Group / Region</label>
        <input class="m-inp" id="m-group" placeholder="e.g. San Diego, Federal">
      </div>
    </div>
    <div class="m-row">
      <div class="m-group">
        <label class="m-lbl">Customer Name</label>
        <input class="m-inp" id="m-customer" placeholder="(optional)">
      </div>
      <div class="m-group">
        <label class="m-lbl">Phone</label>
        <input class="m-inp" id="m-phone" placeholder="(optional)" inputmode="tel">
      </div>
    </div>
    <div class="m-group">
      <label class="m-lbl">Address</label>
      <input class="m-inp" id="m-address" placeholder="(optional) â€” for reference only">
    </div>
    <div class="m-group">
      <label class="m-lbl">Notes</label>
      <input class="m-inp" id="m-notes" placeholder="(optional) â€” Sol-Ark 15K, 2x ECHO, installed 3/24">
    </div>
    <div class="m-group" id="m-code-group" style="display:none">
      <label class="m-lbl">Customer Access Code</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="m-inp" id="m-code" readonly style="font-family:'Orbitron',sans-serif;letter-spacing:4px;text-align:center;font-size:16px;color:var(--bat);flex:1">
        <button class="btn" onclick="regenerateCode()" style="white-space:nowrap;padding:10px 14px">ğŸ”„ NEW</button>
        <button class="btn" onclick="copyCode()" style="white-space:nowrap;padding:10px 14px">ğŸ“‹ COPY</button>
      </div>
      <div class="m-hint">Give this code to the customer so they can view their system.</div>
    </div>
    <div class="m-group" id="m-ssh-group" style="display:none">
      <label class="m-lbl">SSH Quick Reference</label>
      <div id="m-ssh-info" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-family:'DM Mono',monospace;font-size:11px;color:var(--grd);line-height:1.8;position:relative">
      </div>
    </div>
    <input type="hidden" id="m-edit-id" value="">
    <div class="m-btns">
      <button class="btn" onclick="closeModal('modal-add')">CANCEL</button>
      <button class="btn btn-gold" onclick="saveSystem()">SAVE SYSTEM</button>
    </div>
  </div>
</div>

<!-- SETUP GUIDE MODAL -->
<div class="modal-bg" id="modal-setup">
  <div class="modal guide-modal">
    <div class="modal-title"><span>ğŸ“– NEW CLIENT SETUP GUIDE</span> <button class="btn" onclick="closeModal('modal-setup')">âœ•</button></div>

    <div class="guide-text" style="margin-bottom:14px">
      Follow these steps to add a new client's Solar Assistant system to the fleet. You'll need access to their <span class="hl">Solar Assistant web interface</span> to get the connection details.
    </div>

    <!-- STEP 1: GET CLOUD PROXY -->
    <div class="guide-step">
      <div class="guide-step-title"><span class="guide-step-num">1</span> GET THE CLOUD PROXY URL</div>
      <div class="guide-text">
        Open the client's <b>Solar Assistant web interface</b> and navigate to:<br>
        <span class="hl">Settings â†’ Remote Access â†’ Cloud Proxy</span><br><br>
        You'll see a URL that looks like this:
      </div>
      <div class="guide-code-block">
        <span class="lbl">Cloud Proxy</span>
        <span class="val-blue">https://sunfusionenergysystems.us.solar-assistant.io</span>
      </div>
      <div class="guide-text" style="margin-top:6px">
        The part before <b>.us.solar-assistant.io</b> is the <span class="hl">Site ID</span> â€” in this example: <span class="hl-blue">sunfusionenergysystems</span>.<br>
        This is used for <b>remote SSH access</b> and <b>remote monitoring</b>.
      </div>
    </div>

    <!-- STEP 2: GET LOCAL IP -->
    <div class="guide-step">
      <div class="guide-step-title"><span class="guide-step-num">2</span> GET THE LOCAL IP ADDRESS</div>
      <div class="guide-text">
        In the same Solar Assistant interface, find:<br>
        <span class="hl">Settings â†’ Network</span> or look for <b>"Local network"</b><br><br>
        You'll see something like:
      </div>
      <div class="guide-code-block">
        <span class="lbl">Local Network</span>
        <span class="val-blue">http://192.168.0.165</span>
      </div>
      <div class="guide-text" style="margin-top:6px">
        âš¡ <b>Copy only the numbers</b> â€” just the IP address:<br>
      </div>
      <div class="guide-code-block">
        <span class="lbl">Solar Assistant IP (paste this into monitor)</span>
        <span class="val-green" style="font-size:16px">192.168.0.165</span>
      </div>
      <div class="guide-text" style="margin-top:6px">
        This IP goes into the <span class="hl">Solar Assistant IP Address</span> field on the monitor splash screen, <b>and</b> into the <span class="hl">IP Address</span> field when adding the system to Fleet Manager.
      </div>
    </div>

    <!-- STEP 3: SSH SETUP -->
    <div class="guide-step">
      <div class="guide-step-title"><span class="guide-step-num">3</span> SSH INTO SOLAR ASSISTANT</div>
      <div class="guide-text">
        To configure MQTT WebSocket (required for the monitor), you need SSH access.<br>
        Solar Assistant shows the SSH command under:<br>
        <span class="hl">Settings â†’ Remote Access â†’ Configuration</span>
      </div>
      <div class="guide-code-block">
        <span class="lbl">Configuration</span>
        <span class="val-blue">/etc/ssh/sshd_config.d/10-security.conf</span>
      </div>
      <div class="guide-code-block">
        <span class="lbl">Connect With (using local IP)</span>
        <span class="val">ssh solar-assistant@192.168.0.165</span>
        <button class="guide-copy-btn" onclick="guideClip('ssh solar-assistant@192.168.0.165',this)">COPY</button>
      </div>
      <div class="guide-code-block">
        <span class="lbl">Connect With (using Site ID â€” works from anywhere)</span>
        <span class="val">ssh solar-assistant@sunfusionenergysystems.us.solar-assistant.io</span>
        <button class="guide-copy-btn" onclick="guideClip('ssh solar-assistant@sunfusionenergysystems.us.solar-assistant.io',this)">COPY</button>
      </div>
      <div class="guide-code-block">
        <span class="lbl">Password</span>
        <span class="val-green" style="font-size:14px;letter-spacing:3px">solar123</span>
        <button class="guide-copy-btn" onclick="guideClip('solar123',this)">COPY</button>
      </div>
      <div class="guide-text" style="margin-top:6px;font-style:italic;color:var(--txt-3)">
        Password will NOT appear as you type â€” this is normal. Just type it and press Enter.
      </div>
    </div>

    <!-- STEP 4: ENABLE WEBSOCKET -->
    <div class="guide-step">
      <div class="guide-step-title"><span class="guide-step-num">4</span> ENABLE MQTT WEBSOCKET (PORT 9001)</div>
      <div class="guide-text">
        Once logged in via SSH, <b>paste this entire command</b> to add a WebSocket listener:
      </div>
      <div class="guide-code-block" style="line-height:2">
        <button class="guide-copy-btn" onclick="guideClip(`sudo bash -c \'cat >> /etc/mosquitto/mosquitto.conf << EOF\n\n# SunFusion WebSocket listener\nlistener 9001\nprotocol websockets\nallow_anonymous true\nEOF\'`,this)">COPY</button>
        <span class="val" style="font-size:11px">sudo bash -c 'cat >> /etc/mosquitto/mosquitto.conf &lt;&lt; EOF<br><br># SunFusion WebSocket listener<br>listener 9001<br>protocol websockets<br>allow_anonymous true<br>EOF'</span>
      </div>
      <div class="guide-text" style="margin-top:6px">
        Then <b>restart MQTT</b> and <b>verify</b>:
      </div>
      <div class="guide-code-block">
        <button class="guide-copy-btn" onclick="guideClip('sudo systemctl restart mosquitto',this)">COPY</button>
        <span class="val" style="font-size:11px">sudo systemctl restart mosquitto</span>
      </div>
      <div class="guide-code-block">
        <button class="guide-copy-btn" onclick="guideClip('sudo ss -tlnp | grep 9001',this)">COPY</button>
        <span class="lbl">Confirm port 9001 is listening</span>
        <span class="val" style="font-size:11px">sudo ss -tlnp | grep 9001</span>
      </div>
      <div class="guide-text" style="margin-top:6px">
        âœ… If you see <span class="hl-green">LISTEN 0.0.0.0:9001</span> in the output â€” you're good!
      </div>
    </div>

    <!-- STEP 5: ADD TO FLEET -->
    <div class="guide-step">
      <div class="guide-step-title"><span class="guide-step-num">5</span> ADD SYSTEM TO FLEET MANAGER</div>
      <div class="guide-text">
        Click <span class="hl">+ ADD SYSTEM</span> in the Fleet Manager and fill in:
      </div>
      <div style="margin:8px 0;font-family:'DM Mono',monospace;font-size:11px;color:var(--txt-2);line-height:2.2">
        <b style="color:var(--txt)">System Name:</b> <span style="color:var(--txt-3)">Customer's name or address</span><br>
        <b style="color:var(--txt)">IP Address:</b> <span style="color:var(--bat)">192.168.0.165</span> <span style="color:var(--txt-3)">(from Step 2)</span><br>
        <b style="color:var(--txt)">Port:</b> <span style="color:var(--bat)">9001</span><br>
        <b style="color:var(--txt)">Zip Code:</b> <span style="color:var(--txt-3)">Customer's zip (for weather + map)</span><br>
        <b style="color:var(--txt)">Group:</b> <span style="color:var(--txt-3)">Region or installer name (optional)</span><br>
        <b style="color:var(--txt)">Customer / Phone:</b> <span style="color:var(--txt-3)">For your records</span>
      </div>
      <div class="guide-text" style="margin-top:6px">
        After saving, the system gets a <span class="hl-green">6-digit access code</span> automatically. Give this code to the customer so they can look up their system at <span class="hl-blue">customer.html</span>.
      </div>
    </div>

    <!-- STEP 6: VERIFY -->
    <div class="guide-step">
      <div class="guide-step-title"><span class="guide-step-num">6</span> TEST THE CONNECTION</div>
      <div class="guide-text">
        Click the new system in Fleet Manager (or open the monitor directly). You should see:<br><br>
        âœ… Status pill turns <span class="hl-green">â— LIVE</span><br>
        âœ… Power flow diagram shows real-time data<br>
        âœ… Solar, battery, grid, and load values update<br><br>
        If the monitor says <b>"Connectingâ€¦"</b> for more than 15 seconds, the app will automatically try port 1883 as a fallback. Check the <b>MQTT Setup Guide PDF</b> for troubleshooting.
      </div>
    </div>

    <!-- QUICK REFERENCE FOOTER -->
    <div style="border-top:1px solid var(--border);padding-top:14px;margin-top:6px">
      <div class="guide-text" style="text-align:center">
        <b style="color:var(--sol)">Quick Reference â€” Default Credentials</b><br>
        SSH User: <span class="hl-blue">solar-assistant</span> &nbsp;|&nbsp; Password: <span class="hl-green">solar123</span> &nbsp;|&nbsp; MQTT Port: <span class="hl">9001</span>
      </div>
    </div>

    <div class="m-btns" style="margin-top:16px">
      <button class="btn btn-gold" onclick="closeModal('modal-setup');openAddModal()">+ ADD SYSTEM NOW</button>
      <button class="btn" onclick="closeModal('modal-setup')">CLOSE</button>
    </div>
  </div>
</div>

<!-- IMPORT CSV MODAL -->
<div class="modal-bg" id="modal-import">
  <div class="modal">
    <div class="modal-title"><span>IMPORT SYSTEMS</span> <button class="btn" onclick="closeModal('modal-import')">âœ•</button></div>
    <div class="csv-drop" id="csv-drop" onclick="document.getElementById('csv-file').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="event.preventDefault();this.classList.remove('drag');handleCSVFile(event.dataTransfer.files[0])">
      <div class="csv-drop-text">ğŸ“„ Drop CSV file here or click to browse</div>
      <div style="font-size:10px;color:var(--txt-3);margin-top:8px;font-family:'DM Mono',monospace">
        Required columns: <b style="color:var(--sol)">name, ip</b><br>
        Optional: port, zip, group, customer, phone, address, notes
      </div>
    </div>
    <input type="file" id="csv-file" accept=".csv,.txt" style="display:none" onchange="handleCSVFile(this.files[0])">
    <button class="btn" onclick="downloadSampleCSV()" style="width:100%;margin-top:8px">ğŸ“‹ DOWNLOAD SAMPLE CSV TEMPLATE</button>
    <div class="csv-preview" id="csv-preview" style="display:none"></div>
    <div id="csv-status" style="font-size:11px;color:var(--txt-2);margin-top:8px;font-family:'DM Mono',monospace;text-align:center"></div>
    <div class="m-btns">
      <button class="btn" onclick="closeModal('modal-import')">CANCEL</button>
      <button class="btn btn-gold" id="csv-import-btn" onclick="importCSV()" style="display:none">IMPORT SYSTEMS</button>
    </div>
    <div style="border-top:1px solid var(--border);margin-top:16px;padding-top:12px">
      <button class="btn btn-danger" onclick="clearAllSystems()" style="width:100%">ğŸ—‘ DELETE ALL SYSTEMS</button>
    </div>
  </div>
</div>

<script>
// â•â•â• DATABASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME = 'SunFusionFleet';
const DB_VER = 1;
let db = null;
let systems = []; // in-memory cache
let markers = {}; // leaflet markers by id
let markerGroup = null;
let map = null;
let currentView = 'map';
let sortField = 'name';
let sortDir = 'asc';
let csvPendingData = null;
let geoCache = {}; // zip â†’ {lat,lng} cache

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('systems')) {
        const store = db.createObjectStore('systems', { keyPath: 'id' });
        store.createIndex('name', 'name', { unique: false });
        store.createIndex('ip', 'ip', { unique: false });
        store.createIndex('group', 'group', { unique: false });
        store.createIndex('zip', 'zip', { unique: false });
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

function dbPut(sys) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('systems', 'readwrite');
    tx.objectStore('systems').put(sys);
    tx.oncomplete = () => resolve();
    tx.onerror = e => reject(e.target.error);
  });
}

function dbDelete(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('systems', 'readwrite');
    tx.objectStore('systems').delete(id);
    tx.oncomplete = () => resolve();
    tx.onerror = e => reject(e.target.error);
  });
}

function dbGetAll() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('systems', 'readonly');
    const req = tx.objectStore('systems').getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = e => reject(e.target.error);
  });
}

// â•â•â• GEOCODING (zip â†’ lat/lng) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEO_KEY = 'e1402547e7fb3358332b3b921a2e2027';

async function geocodeZip(zip) {
  if (!zip || zip.length < 5) return null;
  if (geoCache[zip]) return geoCache[zip];
  try {
    const r = await fetch(`https://api.openweathermap.org/geo/1.0/zip?zip=${zip},US&appid=${GEO_KEY}`);
    if (!r.ok) return null;
    const d = await r.json();
    const loc = { lat: d.lat, lng: d.lon, city: d.name || '' };
    geoCache[zip] = loc;
    return loc;
  } catch { return null; }
}

// â•â•â• MAP SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap() {
  map = L.map('map', { zoomControl: true, attributionControl: true, preferCanvas: true }).setView([37.5, -96], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap',
    maxZoom: 19
  }).addTo(map);
  markerGroup = L.layerGroup().addTo(map);
}

function createCircleMarker(sys) {
  const color = sys.status === 'online' ? '#00E5A0' : sys.status === 'offline' ? '#ff4444' : '#4a7090';
  return L.circleMarker([sys.lat, sys.lng], {
    radius: 6, fillColor: color, color: 'rgba(255,255,255,0.4)',
    weight: 1.5, fillOpacity: 0.9, bubblingMouseEvents: false
  });
}

function addMapMarker(sys) {
  if (!sys.lat || !sys.lng) return;
  if (markers[sys.id]) markerGroup.removeLayer(markers[sys.id]);

  const m = createCircleMarker(sys);
  m.bindPopup(`
    <div class="sys-popup">
      <div class="sys-popup-name">${esc(sys.name)}</div>
      <div class="sys-popup-ip">${esc(sys.ip)}:${sys.port||9001}</div>
      <div class="sys-popup-row"><span>Access Code</span><span style="font-family:'Orbitron',sans-serif;color:#00E5A0;letter-spacing:2px;font-weight:700">${sys.code||'â€”'}</span></div>
      <div class="sys-popup-row"><span>Group</span><span>${esc(sys.group||'â€”')}</span></div>
      <div class="sys-popup-row"><span>Customer</span><span>${esc(sys.customer||'â€”')}</span></div>
      ${sys.phone?`<div class="sys-popup-row"><span>Phone</span><span>${esc(sys.phone)}</span></div>`:''}
      <a class="sys-popup-btn" href="monitor.html?host=${encodeURIComponent(sys.ip)}&port=${sys.port||9001}&name=${encodeURIComponent(sys.name)}&zip=${sys.zip||''}&mode=admin" target="_blank">OPEN MONITOR â†’</a>
    </div>
  `, { maxWidth: 280 });

  markerGroup.addLayer(m);
  markers[sys.id] = m;
}

function refreshMap() {
  markerGroup.clearLayers();
  markers = {};
  const filtered = getFilteredSystems();
  filtered.forEach(addMapMarker);
  if (filtered.length > 0) {
    const locs = filtered.filter(s => s.lat && s.lng);
    if (locs.length > 0) {
      const bounds = L.latLngBounds(locs.map(s => [s.lat, s.lng]));
      map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });
    }
  }
}

// â•â•â• LIST VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderList() {
  const filtered = getFilteredSystems();
  const tbody = document.getElementById('sys-tbody');
  const empty = document.getElementById('empty-state');

  if (filtered.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = systems.length === 0 ? 'flex' : 'none';
    if (systems.length > 0 && filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--txt-3)">No systems match your search</td></tr>';
    }
    return;
  }
  empty.style.display = 'none';

  // Sort
  const sorted = [...filtered].sort((a, b) => {
    let va = a[sortField] || '', vb = b[sortField] || '';
    if (sortField === 'lastSeen') { va = va || ''; vb = vb || ''; }
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    if (va < vb) return sortDir === 'asc' ? -1 : 1;
    if (va > vb) return sortDir === 'asc' ? 1 : -1;
    return 0;
  });

  // Render (paginated for 30K â€” show first 500, virtual scroll later)
  const show = sorted.slice(0, 500);
  tbody.innerHTML = show.map(s => `
    <tr onclick="openMonitor('${esc(s.ip)}',${s.port||9001},'${esc(s.name)}','${s.zip||''}')">
      <td><span class="status-dot ${s.status||'unknown'}"></span>${(s.status||'unknown').toUpperCase()}</td>
      <td class="sys-name">${esc(s.name)}</td>
      <td class="sys-ip">${esc(s.ip)}</td>
      <td><span class="access-code" onclick="event.stopPropagation();copyToClip('${s.code||''}')" title="Click to copy">${s.code||'â€”'}</span></td>
      <td>${s.group ? `<span class="sys-group-tag">${esc(s.group)}</span>` : 'â€”'}</td>
      <td>${s.zip||'â€”'}</td>
      <td style="color:var(--txt-3)">${s.lastSeen ? timeAgo(s.lastSeen) : 'Never'}</td>
      <td>
        <button class="btn" style="padding:4px 8px;font-size:10px" onclick="event.stopPropagation();editSystem('${s.id}')">âœ</button>
        <button class="btn btn-danger" style="padding:4px 8px;font-size:10px" onclick="event.stopPropagation();deleteSystem('${s.id}')">âœ•</button>
      </td>
    </tr>
  `).join('');

  if (sorted.length > 500) {
    tbody.innerHTML += `<tr><td colspan="8" style="text-align:center;padding:12px;color:var(--txt-3);font-family:'DM Mono',monospace;font-size:11px">Showing 500 of ${sorted.length.toLocaleString()} systems. Use search to narrow results.</td></tr>`;
  }
}

function sortBy(field) {
  if (sortField === field) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
  else { sortField = field; sortDir = 'asc'; }
  document.querySelectorAll('.sys-table th').forEach(th => th.classList.remove('sorted'));
  event.currentTarget.classList.add('sorted');
  event.currentTarget.querySelector('.sort-arrow').textContent = sortDir === 'asc' ? 'â–²' : 'â–¼';
  renderList();
}

// â•â•â• FILTERING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFilteredSystems() {
  const q = (document.getElementById('search').value || '').toLowerCase().trim();
  const grp = document.getElementById('filter-group').value;
  const stat = document.getElementById('filter-status').value;

  return systems.filter(s => {
    if (grp && s.group !== grp) return false;
    if (stat && (s.status || 'unknown') !== stat) return false;
    if (q) {
      const hay = `${s.name} ${s.ip} ${s.group||''} ${s.zip||''} ${s.customer||''} ${s.address||''} ${s.notes||''}`.toLowerCase();
      return hay.includes(q);
    }
    return true;
  });
}

function updateGroupFilter() {
  const sel = document.getElementById('filter-group');
  const current = sel.value;
  const groups = [...new Set(systems.map(s => s.group).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">All Groups (' + systems.length + ')</option>' +
    groups.map(g => {
      const cnt = systems.filter(s => s.group === g).length;
      return `<option value="${esc(g)}" ${g===current?'selected':''}>${esc(g)} (${cnt})</option>`;
    }).join('');
}

// â•â•â• VIEW CONTROL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setView(v) {
  currentView = v;
  document.getElementById('vbtn-map').classList.toggle('active', v === 'map');
  document.getElementById('vbtn-list').classList.toggle('active', v === 'list');
  document.getElementById('map-container').classList.toggle('hidden', v !== 'map');
  document.getElementById('list-container').classList.toggle('active', v === 'list');
  if (v === 'map') { setTimeout(() => map.invalidateSize(), 100); refreshMap(); }
  else renderList();
}

function renderView() {
  updateStats();
  if (currentView === 'map') refreshMap();
  else renderList();
}

function updateStats() {
  const filtered = getFilteredSystems();
  document.getElementById('stat-total').textContent = systems.length.toLocaleString();
  document.getElementById('stat-online').textContent = systems.filter(s => s.status === 'online').length.toLocaleString();
  document.getElementById('stat-offline').textContent = systems.filter(s => s.status === 'offline').length.toLocaleString();
}

// â•â•â• SYSTEM CRUD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal() {
  document.getElementById('modal-add-title').textContent = 'ADD SYSTEM';
  ['m-name','m-ip','m-zip','m-group','m-customer','m-phone','m-address','m-notes','m-siteid'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('m-port').value = '9001';
  document.getElementById('m-edit-id').value = '';
  document.getElementById('m-code-group').style.display = 'none';
  document.getElementById('m-ssh-group').style.display = 'none';
  openModal('modal-add');
  setTimeout(() => document.getElementById('m-name').focus(), 200);
}

function editSystem(id) {
  const sys = systems.find(s => s.id === id);
  if (!sys) return;
  document.getElementById('modal-add-title').textContent = 'EDIT SYSTEM';
  document.getElementById('m-name').value = sys.name || '';
  document.getElementById('m-ip').value = sys.ip || '';
  document.getElementById('m-port').value = sys.port || 9001;
  document.getElementById('m-siteid').value = sys.siteid || '';
  document.getElementById('m-zip').value = sys.zip || '';
  document.getElementById('m-group').value = sys.group || '';
  document.getElementById('m-customer').value = sys.customer || '';
  document.getElementById('m-phone').value = sys.phone || '';
  document.getElementById('m-address').value = sys.address || '';
  document.getElementById('m-notes').value = sys.notes || '';
  document.getElementById('m-edit-id').value = id;
  // Show access code
  document.getElementById('m-code').value = sys.code || generateCode();
  document.getElementById('m-code-group').style.display = 'block';
  // Show SSH info
  const sshDiv = document.getElementById('m-ssh-info');
  const ip = sys.ip || '[IP]';
  const sid = sys.siteid || '';
  let h = '';
  h += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span><span style="color:var(--txt-3)">Local SSH:</span> <span style="color:var(--sol)">ssh solar-assistant@${esc(ip)}</span></span><button class="btn" onclick="copySSH('local')" style="padding:4px 10px;font-size:9px">ğŸ“‹ COPY</button></div>`;
  if (sid) {
    h += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span><span style="color:var(--txt-3)">Remote SSH:</span> <span style="color:var(--sol)">ssh solar-assistant@${esc(sid)}</span></span><button class="btn" onclick="copySSH('remote')" style="padding:4px 10px;font-size:9px">ğŸ“‹ COPY</button></div>`;
    h += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span><span style="color:var(--txt-3)">Cloud URL:</span> <span style="color:var(--grd)">https://${esc(sid)}</span></span><button class="btn" onclick="copySSH('cloud')" style="padding:4px 10px;font-size:9px">ğŸ“‹ COPY</button></div>`;
  }
  h += `<div style="display:flex;justify-content:space-between;align-items:center"><span><span style="color:var(--txt-3)">Password:</span> <span style="color:var(--bat)">solar123</span></span><button class="btn" onclick="copySSH('pass')" style="padding:4px 10px;font-size:9px">ğŸ“‹ COPY</button></div>`;
  sshDiv.innerHTML = h;
  document.getElementById('m-ssh-group').style.display = 'block';
  openModal('modal-add');
}

async function saveSystem() {
  const name = document.getElementById('m-name').value.trim();
  const ip = document.getElementById('m-ip').value.trim();
  if (!name || !ip) { alert('Name and IP address are required.'); return; }

  const editId = document.getElementById('m-edit-id').value;
  const sys = editId ? systems.find(s => s.id === editId) || {} : {};

  sys.id = sys.id || 'sys_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
  sys.name = name;
  sys.ip = ip;
  sys.port = parseInt(document.getElementById('m-port').value) || 9001;
  sys.zip = document.getElementById('m-zip').value.trim();
  sys.group = document.getElementById('m-group').value.trim();
  sys.customer = document.getElementById('m-customer').value.trim();
  sys.phone = document.getElementById('m-phone').value.trim();
  sys.address = document.getElementById('m-address').value.trim();
  sys.notes = document.getElementById('m-notes').value.trim();
  sys.siteid = document.getElementById('m-siteid').value.trim().replace(/^https?:\/\//, '');
  sys.status = sys.status || 'unknown';
  sys.lastSeen = sys.lastSeen || null;
  sys.created = sys.created || new Date().toISOString();

  // Access code â€” keep existing or generate new
  if (editId && document.getElementById('m-code').value) {
    sys.code = document.getElementById('m-code').value;
  } else {
    sys.code = sys.code || generateCode();
  }

  // Geocode zip
  if (sys.zip && !sys.lat) {
    const loc = await geocodeZip(sys.zip);
    if (loc) { sys.lat = loc.lat; sys.lng = loc.lng; sys.city = loc.city; }
  }

  await dbPut(sys);
  if (!editId) systems.push(sys);
  else { const idx = systems.findIndex(s => s.id === sys.id); if (idx >= 0) systems[idx] = sys; }

  closeModal('modal-add');
  updateGroupFilter();
  renderView();
}

async function deleteSystem(id) {
  const sys = systems.find(s => s.id === id);
  if (!sys || !confirm(`Delete "${sys.name}"?`)) return;
  await dbDelete(id);
  systems = systems.filter(s => s.id !== id);
  if (markers[id]) { markerGroup.removeLayer(markers[id]); delete markers[id]; }
  updateGroupFilter();
  renderView();
}

function openMonitor(ip, port, name, zip) {
  const url = `monitor.html?host=${encodeURIComponent(ip)}&port=${port}&name=${encodeURIComponent(name)}&zip=${zip}&mode=admin`;
  window.open(url, '_blank');
}

// â•â•â• CSV IMPORT/EXPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleCSVFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) { document.getElementById('csv-status').textContent = 'File is empty or has no data rows.'; return; }

    const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
    const nameIdx = headers.findIndex(h => h === 'name' || h === 'system_name' || h === 'site');
    const ipIdx = headers.findIndex(h => h === 'ip' || h === 'ip_address' || h === 'host');

    if (nameIdx < 0 || ipIdx < 0) {
      document.getElementById('csv-status').innerHTML = '<span style="color:var(--danger)">CSV must have "name" and "ip" columns. Found: ' + headers.join(', ') + '</span>';
      return;
    }

    const portIdx = headers.findIndex(h => h === 'port');
    const zipIdx = headers.findIndex(h => h === 'zip' || h === 'zipcode' || h === 'zip_code');
    const groupIdx = headers.findIndex(h => h === 'group' || h === 'region');
    const codeIdx = headers.findIndex(h => h === 'code' || h === 'access_code');
    const sidIdx = headers.findIndex(h => h === 'siteid' || h === 'site_id' || h === 'cloud_proxy');
    const custIdx = headers.findIndex(h => h === 'customer' || h === 'customer_name' || h === 'owner');
    const phoneIdx = headers.findIndex(h => h === 'phone' || h === 'tel');
    const addrIdx = headers.findIndex(h => h === 'address' || h === 'location');
    const notesIdx = headers.findIndex(h => h === 'notes' || h === 'description');

    csvPendingData = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      const name = (cols[nameIdx] || '').trim();
      const ip = (cols[ipIdx] || '').trim();
      if (!name || !ip) continue;
      csvPendingData.push({
        name, ip,
        port: portIdx >= 0 ? parseInt(cols[portIdx]) || 9001 : 9001,
        zip: zipIdx >= 0 ? (cols[zipIdx] || '').trim() : '',
        group: groupIdx >= 0 ? (cols[groupIdx] || '').trim() : '',
        code: codeIdx >= 0 ? (cols[codeIdx] || '').trim() : '',
        siteid: sidIdx >= 0 ? (cols[sidIdx] || '').trim() : '',
        customer: custIdx >= 0 ? (cols[custIdx] || '').trim() : '',
        phone: phoneIdx >= 0 ? (cols[phoneIdx] || '').trim() : '',
        address: addrIdx >= 0 ? (cols[addrIdx] || '').trim() : '',
        notes: notesIdx >= 0 ? (cols[notesIdx] || '').trim() : ''
      });
    }

    // Preview
    const preview = document.getElementById('csv-preview');
    preview.style.display = 'block';
    preview.textContent = csvPendingData.slice(0, 10).map((s, i) =>
      `${i + 1}. ${s.name} â€” ${s.ip} ${s.zip ? '('+s.zip+')' : ''} ${s.group || ''}`
    ).join('\n') + (csvPendingData.length > 10 ? `\n... and ${csvPendingData.length - 10} more` : '');

    document.getElementById('csv-status').innerHTML = `<span style="color:var(--bat)">${csvPendingData.length.toLocaleString()} systems ready to import</span>`;
    document.getElementById('csv-import-btn').style.display = 'block';
  };
  reader.readAsText(file);
}

function parseCSVLine(line) {
  const result = [];
  let current = '', inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQuotes = !inQuotes; }
    else if (c === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else { current += c; }
  }
  result.push(current.trim());
  return result;
}

async function importCSV() {
  if (!csvPendingData || csvPendingData.length === 0) return;
  const btn = document.getElementById('csv-import-btn');
  btn.textContent = 'IMPORTING...';
  btn.disabled = true;

  const status = document.getElementById('csv-status');
  let imported = 0, skipped = 0;

  for (let i = 0; i < csvPendingData.length; i++) {
    const d = csvPendingData[i];
    // Skip if IP already exists
    if (systems.find(s => s.ip === d.ip)) { skipped++; continue; }

    const sys = {
      id: 'sys_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8),
      ...d,
      code: d.code || generateCode(),
      status: 'unknown',
      lastSeen: null,
      created: new Date().toISOString(),
      lat: null, lng: null, city: ''
    };

    // Geocode in batches (throttled)
    if (sys.zip) {
      const loc = await geocodeZip(sys.zip);
      if (loc) { sys.lat = loc.lat; sys.lng = loc.lng; sys.city = loc.city; }
      // Throttle to avoid rate limiting
      if (imported % 50 === 0 && imported > 0) await new Promise(r => setTimeout(r, 1000));
    }

    await dbPut(sys);
    systems.push(sys);
    imported++;

    if (imported % 100 === 0) {
      status.innerHTML = `<span style="color:var(--sol)">Importing... ${imported.toLocaleString()} / ${csvPendingData.length.toLocaleString()}</span>`;
    }
  }

  csvPendingData = null;
  btn.textContent = 'IMPORT SYSTEMS';
  btn.disabled = false;
  btn.style.display = 'none';

  status.innerHTML = `<span style="color:var(--bat)">âœ“ Imported ${imported.toLocaleString()} systems${skipped > 0 ? `, skipped ${skipped} duplicates` : ''}</span>`;

  updateGroupFilter();
  renderView();
  setTimeout(() => closeModal('modal-import'), 2000);
}

function exportCSV() {
  if (systems.length === 0) { alert('No systems to export.'); return; }
  const headers = ['name','ip','port','zip','group','code','siteid','customer','phone','address','notes','status','lat','lng','created'];
  const rows = systems.map(s => headers.map(h => `"${(s[h]||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  downloadCSV(csv, `sunfusion_fleet_${new Date().toISOString().split('T')[0]}.csv`);
}

function downloadSampleCSV() {
  const sample = `name,ip,port,zip,group,customer,phone,address,notes
"Smith Residence","192.168.1.50",9001,"92081","San Diego","John Smith","858-555-0100","123 Main St","Sol-Ark 15K, 2x ECHO"
"Warehouse #12","10.0.1.100",9001,"92101","Commercial","ABC Corp","858-555-0200","456 Industrial Blvd","Sol-Ark 30K 3-phase"
"Jones Family","192.168.1.75",9001,"92024","North County","Mary Jones","760-555-0300","789 Oak Ave","Sol-Ark 12K, 1x Guardian"`;
  downloadCSV(sample, 'sunfusion_fleet_template.csv');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

async function clearAllSystems() {
  if (!confirm(`Delete ALL ${systems.length.toLocaleString()} systems?\n\nThis cannot be undone.`)) return;
  if (!confirm(`Are you sure? This will permanently remove all system data.`)) return;
  const tx = db.transaction('systems', 'readwrite');
  tx.objectStore('systems').clear();
  await new Promise(r => { tx.oncomplete = r; });
  systems = [];
  markerGroup.clearLayers();
  markers = {};
  updateGroupFilter();
  renderView();
}

// â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function timeAgo(iso) {
  if (!iso) return 'Never';
  const ms = Date.now() - new Date(iso).getTime();
  if (ms < 60000) return 'Just now';
  if (ms < 3600000) return Math.floor(ms / 60000) + 'm ago';
  if (ms < 86400000) return Math.floor(ms / 3600000) + 'h ago';
  return Math.floor(ms / 86400000) + 'd ago';
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close modals on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-bg.open').forEach(m => m.classList.remove('open'));
  }
});

// â•â•â• ACCESS CODE SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateCode() {
  // 6-character alphanumeric, uppercase, no ambiguous chars (0/O, 1/I/L)
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  // Ensure uniqueness
  while (systems.find(s => s.code === code)) {
    code = '';
    for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

function regenerateCode() {
  document.getElementById('m-code').value = generateCode();
}

function copyCode() {
  const code = document.getElementById('m-code').value;
  copyToClip(code);
}

function copyToClip(text) {
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    const orig = event?.target?.textContent;
    if (event?.target) { event.target.textContent = 'âœ“'; setTimeout(() => { event.target.textContent = orig; }, 1000); }
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  });
}

function guideClip(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'âœ“ COPIED';
    btn.style.color = '#00E5A0';
    btn.style.borderColor = 'rgba(0,229,160,0.3)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; btn.style.borderColor = ''; }, 1500);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    btn.textContent = 'âœ“ COPIED';
    setTimeout(() => { btn.textContent = 'COPY'; }, 1500);
  });
}

function copyField(id) {
  const v = document.getElementById(id).value.trim();
  if (!v) return;
  navigator.clipboard.writeText(v).catch(() => {
    const ta = document.createElement('textarea'); ta.value = v; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  });
}

function copySiteURL() {
  const raw = document.getElementById('m-siteid').value.trim();
  if (!raw) return;
  const clean = raw.replace(/^https?:\/\//, '');
  const url = 'https://' + clean;
  const btn = document.getElementById('btn-copy-site');
  navigator.clipboard.writeText(url).then(() => {
    btn.textContent = 'âœ“ COPIED';
    btn.style.color = '#00E5A0';
    setTimeout(() => { btn.textContent = 'ğŸ“‹ COPY URL'; btn.style.color = ''; }, 1500);
  }).catch(() => {
    const ta = document.createElement('textarea'); ta.value = url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    btn.textContent = 'âœ“ COPIED';
    setTimeout(() => { btn.textContent = 'ğŸ“‹ COPY URL'; }, 1500);
  });
}

function copySSH(type) {
  const ip = document.getElementById('m-ip').value.trim();
  const sid = document.getElementById('m-siteid').value.trim().replace(/^https?:\/\//, '');
  let text = '';
  if (type === 'local') text = 'ssh solar-assistant@' + ip;
  else if (type === 'remote') text = 'ssh solar-assistant@' + sid;
  else if (type === 'cloud') text = 'https://' + sid;
  else if (type === 'pass') text = 'solar123';
  if (!text) return;
  navigator.clipboard.writeText(text).catch(() => {
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  });
}

// â•â•â• ADMIN AUTHENTICATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FLEET_ADMIN_PASS = 'ess123';  // Change this to your admin password
const SESSION_KEY = 'sf_fleet_session';
const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 hours

function isSessionValid() {
  try {
    const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || '{}');
    if (sess.token && sess.expires && Date.now() < sess.expires) return true;
  } catch {}
  return false;
}

function createSession() {
  const sess = {
    token: Math.random().toString(36).slice(2) + Date.now().toString(36),
    expires: Date.now() + SESSION_DURATION
  };
  localStorage.setItem(SESSION_KEY, JSON.stringify(sess));
}

function destroySession() {
  localStorage.removeItem(SESSION_KEY);
}

function adminLogin() {
  const inp = document.getElementById('login-pass');
  const msg = document.getElementById('login-msg');
  if (inp.value === FLEET_ADMIN_PASS) {
    createSession();
    showFleet();
  } else {
    inp.classList.remove('err');
    void inp.offsetWidth;
    inp.classList.add('err');
    inp.value = '';
    msg.innerHTML = '<span style="color:var(--danger)">Incorrect password</span>';
    setTimeout(() => inp.focus(), 100);
  }
}

function lockFleet() {
  destroySession();
  document.getElementById('fleet-root').style.display = 'none';
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('login-pass').value = '';
  document.getElementById('login-msg').textContent = '';
  setTimeout(() => document.getElementById('login-pass').focus(), 200);
}

function showFleet() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('fleet-root').style.display = 'flex';
  setTimeout(() => { if (map) map.invalidateSize(); }, 100);
}

// â•â•â• CUSTOMER LOOKUP (for customer.html) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Systems are stored in IndexedDB â€” customer.html reads from same DB
// Each system has a unique .code field that the customer uses to look up

// â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  await openDB();
  systems = await dbGetAll();

  // Auto-generate codes for any systems that don't have one yet
  let updated = false;
  for (const sys of systems) {
    if (!sys.code) {
      sys.code = generateCode();
      await dbPut(sys);
      updated = true;
    }
  }

  // Check admin session
  if (isSessionValid()) {
    showFleet();
  } else {
    document.getElementById('login-screen').classList.remove('hidden');
    setTimeout(() => document.getElementById('login-pass').focus(), 300);
  }

  initMap();
  updateGroupFilter();
  updateStats();
  renderView();

  const params = new URLSearchParams(location.search);
  if (params.get('add') === '1') openAddModal();
})();
</script>
</body>
</html>
